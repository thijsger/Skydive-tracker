<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skydive Tracker v3 (Cloud)</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#121a2b;--panel-2:#0f1626;--text:#ebf4ff;--muted:#9fb3d0;--primary:#4cc9f0;--primary-2:#4895ef;--accent:#f72585;--good:#2dd4bf;--warn:#fbbf24;--bad:#ef4444;--ok:#22c55e;--chip:#1f2940;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Ubuntu,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(135deg,#0b1220 0%,#0d1730 45%, #0a1230 100%);color:var(--text)}
    a{color:var(--primary)}
    header{position:sticky;top:0;z-index:4;backdrop-filter:saturate(1.1) blur(10px);background:linear-gradient(180deg,rgba(10,18,40,.9),rgba(10,18,40,.6));border-bottom:1px solid rgba(255,255,255,.06)}
    .bar{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px}
    .brand{display:flex;gap:12px;align-items:center;font-weight:800;letter-spacing:.4px}
    .logo{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #4cc9f0, #4895ef 60%, #f72585 100%);box-shadow:var(--shadow)}
    .logo span{font-size:18px;color:#08111f;font-weight:900}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--primary-2);color:#021026;font-weight:700;box-shadow:var(--shadow);cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{background:var(--chip);color:var(--text);border:1px solid rgba(255,255,255,.08)}
    .btn.warn{background:var(--warn);color:#1b1300}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
    .chip{background:var(--chip);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;color:var(--muted);font-weight:600;display:inline-flex;gap:8px;align-items:center}
    main{max-width:1200px;margin:24px auto;padding:0 18px;display:grid;grid-template-columns:330px 1fr 360px;gap:16px}
    @media (max-width:1100px){main{grid-template-columns:1fr;}}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow);border-radius:var(--radius);padding:16px}
    .card h3{margin:0 0 10px 0;font-size:18px}
    .sub{color:var(--muted);font-size:13px}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0b1324;color:var(--text)}
    textarea{min-height:70px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,.08);font-size:13px}
    th{color:var(--muted);font-weight:700}
    tr:hover td{background:rgba(255,255,255,.03)}
    .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;background:linear-gradient(180deg,#15213a,#0f1730);border:1px solid rgba(255,255,255,.12);margin:4px 6px 0 0}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0b1324;font-size:12px;color:var(--muted)}
    .status{display:inline-flex;gap:8px;align-items:center;font-weight:800}
    .status.go{color:var(--ok)}.status.caution{color:var(--warn)}.status.hold{color:var(--bad)}
    .hidden{display:none}
  </style>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // VUL DIT IN met jouw Supabase project gegevens
    const SUPABASE_URL = "https://jptgghxniqqoyxxxgcmy.supabase.co"; // <-- aanpassen
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwdGdnaHhuaXFxb3l4eHhnY215Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTQwMTIsImV4cCI6MjA3MTc3MDAxMn0.KugjNF2p0hlHguXuedEU63GzLbRRYcc2kfF_4Ul6CRk";           // <-- aanpassen
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo"><span>🪂</span></div>
        <div>
          <div>Skydive Tracker <span class="pill">v3 cloud</span></div>
          <div class="sub">Accounts in Supabase • Sprongen in de cloud • Publiek leaderboard</div>
        </div>
      </div>
      <div class="toolbar" id="topToolbar" hidden>
        <span class="chip" id="chipUser">👤 —</span>
        <button class="btn warn" id="btnLogout">Log uit</button>
      </div>
    </div>
  </header>

  <!-- AUTH -->
  <section id="authSection" class="card" style="max-width:920px;margin:30px auto;">
    <h3>Inloggen of Account maken</h3>
    <div class="grid-2">
      <div>
        <div class="sub">Inloggen (e‑mail & wachtwoord)</div>
        <label>E‑mail</label>
        <input id="loginEmail" placeholder="jij@example.com" />
        <label>Wachtwoord</label>
        <input id="loginPass" type="password" placeholder="••••••" />
        <button class="btn" id="btnLogin" style="margin-top:10px">Inloggen</button>
      </div>
      <div>
        <div class="sub">Registreren (maakt ook je profiel aan)</div>
        <label>E‑mail</label>
        <input id="regEmail" placeholder="jij@example.com" />
        <label>Wachtwoord</label>
        <input id="regPass" type="password" placeholder="min. 6 karakters" />
        <label>Publieke gebruikersnaam (voor leaderboard)</label>
        <input id="regUsername" placeholder="bijv. thijs" />
        <div class="grid-2">
          <div>
            <label>Standaard DZ</label>
            <input id="regDZ" value="Skydive Teuge" />
          </div>
          <div>
            <label>Open‑Meteo URL (optioneel)</label>
            <input id="regApi" placeholder="Laat leeg voor auto" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label>Lat</label>
            <input id="regLat" type="number" step="0.0001" value="52.2375" />
          </div>
          <div>
            <label>Lon</label>
            <input id="regLon" type="number" step="0.0001" value="6.05" />
          </div>
        </div>
        <button class="btn" id="btnRegister" style="margin-top:10px">Account aanmaken</button>
      </div>
    </div>
    <div id="authMsg" class="sub" style="margin-top:12px"></div>
  </section>

  <main id="app" class="hidden">
    <div class="card">
      <h3>Jouw profiel</h3>
      <div class="sub">Profielwaarden worden opgeslagen in Supabase</div>
      <div class="grid-3" style="margin-top:6px">
        <div><label>Gebruikersnaam</label><input id="pUsername" /></div>
        <div><label>Dropzone</label><input id="pDZ" /></div>
        <div><label>Open‑Meteo URL</label><input id="pApi" /></div>
      </div>
      <div class="grid-3">
        <div><label>Lat</label><input id="pLat" type="number" step="0.0001" /></div>
        <div><label>Lon</label><input id="pLon" type="number" step="0.0001" /></div>
        <div style="display:flex;align-items:flex-end"><button class="btn" id="btnSaveProfile">Opslaan</button></div>
      </div>
    </div>

    <div class="card">
      <h3>Live Weer & Veiligheidscheck</h3>
      <div class="sub" id="weatherNote">Gebaseerd op jouw profielcoördinaten</div>
      <div id="weatherData" style="margin-top:8px">—</div>
      <div id="safetyStatus" style="margin-top:8px" class="status">—</div>
      <div style="margin-top:10px"><button class="btn secondary" id="btnRefreshWeather">Ververs weer</button></div>
      <div class="sub" style="margin-top:8px">Drempels: wind ≤22 km/u (beginners) of ≤32 km/u (gevorderd), zicht ≥5 km, bewolking ≤60%, neerslagkans ≤20%. Altijd DZ/S&TA volgen.</div>
    </div>

    <div class="card">
      <h3>Sprong loggen</h3>
      <form id="jumpForm">
        <div class="grid-3">
          <div>
            <label>Datum & tijd</label>
            <input id="jfDate" type="datetime-local" required />
          </div>
          <div>
            <label>Dropzone</label>
            <input id="jfDZ" required />
          </div>
          <div>
            <label>Type</label>
            <select id="jfType">
              <option>Solo</option><option>Tandem</option><option>AFF</option><option>RW</option><option>Freefly</option><option>Wingsuit</option><option>Canopy</option><option>Coach</option>
            </select>
          </div>
        </div>
        <div class="grid-3">
          <div><label>Exit (m)</label><input id="jfExit" type="number" step="10" required /></div>
          <div><label>Open (m)</label><input id="jfOpen" type="number" step="10" required /></div>
          <div><label>Vrije val (s)</label><input id="jfFF" type="number" step="1" required /></div>
        </div>
        <div class="grid-3">
          <div><label>Lat</label><input id="jfLat" type="number" step="0.0001" required /></div>
          <div><label>Lon</label><input id="jfLon" type="number" step="0.0001" required /></div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button type="button" class="btn secondary" id="btnFormWeather">Weer snapshot</button>
            <button class="btn" type="submit">Opslaan</button>
          </div>
        </div>
        <label>Notities</label>
        <textarea id="jfNotes" placeholder="line‑up, spot, exit, canopy pattern, landing…"></textarea>
        <div id="formWeatherSnapshot" class="sub">—</div>
      </form>
    </div>

    <div class="card">
      <h3>Jouw sprongen</h3>
      <div class="sub" id="jumpCount">—</div>
      <div style="overflow:auto;margin-top:6px">
        <table id="jumpTable">
          <thead><tr><th>#</th><th>Datum</th><th>Type</th><th>DZ</th><th>Exit</th><th>FF</th><th>Wind</th><th>Weer</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Publiek Leaderboard</h3>
      <div class="sub">Op basis van XP (berekend in view) — iedereen kan dit zien</div>
      <table id="lbTable" style="margin-top:6px">
        <thead><tr><th>#</th><th>Gebruiker</th><th>Sprongen</th><th>XP</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
  (function(){
    const DEFAULT_HOURLY = [
      'temperature_2m','relative_humidity_2m','wind_speed_10m','wind_gusts_10m','apparent_temperature',
      'wind_direction_10m','precipitation_probability','precipitation','weather_code','cloud_cover','visibility'
    ].join(',');
    const DEFAULT_TZ = 'Europe/Amsterdam';

    // Helpers
    const $ = s => document.querySelector(s);
    const fmt = (n,d=0)=> Number(n).toFixed(d);

    function nowLocalDatetime(){ const dt=new Date(); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset()); return dt.toISOString().slice(0,16); }

    function wmoText(code){
      const map={0:'Kraakhelder',1:'Overwegend helder',2:'Deels bewolkt',3:'Bewolkt',45:'Mist',48:'Rijpmist',51:'Motregen licht',53:'Motregen',55:'Motregen zwaar',56:'IJzel licht',57:'IJzel',61:'Regen licht',63:'Regen',65:'Regen zwaar',66:'IJzel regen licht',67:'IJzel regen',71:'Sneeuw licht',73:'Sneeuw',75:'Sneeuw zwaar',77:'Sneeuwkorrels',80:'Buien licht',81:'Buien',82:'Buien zwaar',85:'Sneeuwbuien licht',86:'Sneeuwbuien',95:'Onweer',96:'Onweer + hagel',99:'Hevig onweer'}; return map[code]||`Code ${code}`;
    }

    function evalSafety(level, w){
      const wind = Number(w.wind||0), gust=Number(w.gust||0), cloud=Number(w.cloud||0), vis=Number(w.vis||0), p=Number(w.precipProb||0), r=Number(w.precip||0);
      const limit = level<3?22:32, gustLimit=limit+10;
      const bad=[
        wind>limit?`Wind ${fmt(wind)}>${limit}`:null,
        gust>gustLimit?`Gust ${fmt(gust)}>${gustLimit}`:null,
        cloud>60?`Bewolking ${fmt(cloud)}%>60%`:null,
        vis<5000?`Zicht ${fmt(vis/1000,1)}km<5km`:null,
        !(p<=20 && r<=0.1)?`Neerslag ${fmt(p)}%/${fmt(r,1)}mm`:null
      ].filter(Boolean);
      let status='go',label='GO'; if(bad.length===1){status='caution';label='CAUTION';} if(bad.length>=2){status='hold';label='HOLD';}
      return {status,label,reasons:bad};
    }

    async function supaUser(){ const { data:{ user } } = await supabase.auth.getUser(); return user; }

    // PROFILE
    async function loadProfile(){
      const user = await supaUser(); if(!user) return null;
      const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if(error){ console.warn(error); return null; }
      return data;
    }
    async function saveProfile(p){
      const user = await supaUser(); if(!user) throw new Error('Niet ingelogd');
      p.id = user.id;
      const { error } = await supabase.from('profiles').upsert(p);
      if(error) throw error;
    }

    // JUMPS
    async function saveJump(j){
      const user = await supaUser(); if(!user) throw new Error('Niet ingelogd');
      const row={ user_id:user.id, dt:new Date(j.date).toISOString(), dz:j.dz, type:j.type, exit_alt:j.exitAlt, open_alt:j.openAlt, ff:j.ff, lat:j.lat, lon:j.lon, notes:j.notes||null, weather:j.weather||null };
      const { error } = await supabase.from('jumps').insert(row); if(error) throw error;
    }
    async function fetchMyJumps(){
      const { data, error } = await supabase.from('jumps').select('*').order('dt',{ascending:false});
      if(error) throw error; return data||[];
    }

    // LEADERBOARD (publieke view)
    async function fetchLeaderboard(){ const { data, error } = await supabase.from('leaderboard').select('*'); if(error) throw error; return data||[]; }

    // WEATHER
    async function fetchWeather(lat,lon,api){
      let url = api && api.trim().length? api.trim() : `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=${DEFAULT_HOURLY}&timezone=${encodeURIComponent('Europe/Amsterdam')}`;
      try{ const u=new URL(url); u.searchParams.set('latitude',lat); u.searchParams.set('longitude',lon); if(!u.searchParams.has('hourly')) u.searchParams.set('hourly',DEFAULT_HOURLY); url=u.toString(); }catch{}
      const r = await fetch(url); if(!r.ok) throw new Error('Weer mislukt'); const j=await r.json();
      const idx = nearestHourIndex(j.hourly.time);
      return { time:j.hourly.time[idx], temp:j.hourly.temperature_2m?.[idx], rh:j.hourly.relative_humidity_2m?.[idx], wind:j.hourly.wind_speed_10m?.[idx], gust:j.hourly.wind_gusts_10m?.[idx], app:j.hourly.apparent_temperature?.[idx], dir:j.hourly.wind_direction_10m?.[idx], precipProb:j.hourly.precipitation_probability?.[idx], precip:j.hourly.precipitation?.[idx], code:j.hourly.weather_code?.[idx], cloud:j.hourly.cloud_cover?.[idx], vis:j.hourly.visibility?.[idx] };
    }
    function nearestHourIndex(arr){ const now=Date.now(); let best=0,d=1/0; arr.forEach((t,i)=>{const dt=Math.abs(new Date(t)-now); if(dt<d){d=dt;best=i}}); return best; }

    // RENDER
    function renderWeather(profile, w){
      const level = 1; // voor nu: bereken XP/level server-side in de view; level hier niet strikt nodig
      const s = evalSafety(level,w);
      $('#weatherData').innerHTML = `
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <span class="pill">🕒 ${new Date(w.time).toLocaleString()}</span>
          <span class="pill">🌡️ ${fmt(w.temp,1)}°C (gevoel ${fmt(w.app,1)}°)</span>
          <span class="pill">💨 ${fmt(w.wind,0)} km/u, gust ${fmt(w.gust,0)}</span>
          <span class="pill">☁️ ${fmt(w.cloud,0)}%</span>
          <span class="pill">👁️ ${fmt((w.vis||0)/1000,1)} km</span>
          <span class="pill">🌧️ ${fmt(w.precipProb||0,0)}% / ${fmt(w.precip||0,1)} mm</span>
          <span class="pill">${wmoText(w.code)}</span>
        </div>`;
      const el=$('#safetyStatus'); el.className=`status ${s.status}`; const icon=s.status==='go'?'✅':s.status==='caution'?'⚠️':'⛔'; el.textContent=`${icon} ${s.label}${s.reasons.length? ' — '+s.reasons.join(' · '): ''}`;
    }

    function renderJumps(rows){
      $('#jumpCount').textContent = `${rows.length} sprongen`;
      const tb = $('#jumpTable tbody'); tb.innerHTML='';
      rows.forEach((j,i)=>{
        const w=j.weather||{}; const tr=document.createElement('tr');
        tr.innerHTML = `<td>${rows.length-i}</td><td>${new Date(j.dt).toLocaleString()}</td><td>${j.type}</td><td>${j.dz}</td><td>${j.exit_alt}</td><td>${j.ff}</td><td>${w.wind?fmt(w.wind,0):'-'}/${w.gust?fmt(w.gust,0):'-'}</td><td>${wmoText(w.code||'-')}</td>`;
        tb.appendChild(tr);
      })
    }

    function renderLeaderboard(rows){
      const tb = $('#lbTable tbody'); tb.innerHTML='';
      rows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${r.username||'—'}</td><td>${r.jumps||0}</td><td>${r.xp||0}</td>`;
        tb.appendChild(tr);
      })
    }

    async function refreshAll(){
      const user = await supaUser(); if(!user){ showAuth(); return; }
      $('#chipUser').textContent = `👤 ${user.email}`;
      const profile = await loadProfile();
      if(profile){
        $('#pUsername').value = profile.username||''; $('#pDZ').value=profile.dz||''; $('#pApi').value=profile.api||''; $('#pLat').value=profile.lat||''; $('#pLon').value=profile.lon||'';
        $('#jfDZ').value = profile.dz||''; $('#jfLat').value=profile.lat||''; $('#jfLon').value=profile.lon||''; $('#jfDate').value = nowLocalDatetime();
        try{ const w=await fetchWeather(profile.lat,profile.lon,profile.api); lastWeather=w; renderWeather(profile,w);}catch(e){ $('#weatherData').innerHTML='<span class="sub">Weer niet beschikbaar</span>'; $('#safetyStatus').textContent='—'; }
      }
      const jumps = await fetchMyJumps(); renderJumps(jumps);
      const lb = await fetchLeaderboard(); renderLeaderboard(lb);
    }

    function showApp(){ $('#authSection').classList.add('hidden'); $('#app').classList.remove('hidden'); $('#topToolbar').hidden=false; }
    function showAuth(){ $('#authSection').classList.remove('hidden'); $('#app').classList.add('hidden'); $('#topToolbar').hidden=true; }

    // AUTH handlers
    $('#btnRegister').onclick = async ()=>{
      const email=$('#regEmail').value.trim(); const pass=$('#regPass').value; const username=$('#regUsername').value.trim();
      const dz=$('#regDZ').value.trim()||'Skydive Teuge'; const api=$('#regApi').value.trim(); const lat=parseFloat($('#regLat').value)||52.2375; const lon=parseFloat($('#regLon').value)||6.05;
      $('#authMsg').textContent='';
      const { data, error } = await supabase.auth.signUp({ email, password: pass });
      if(error){ $('#authMsg').textContent = 'Fout: '+error.message; return; }
      // profiel direct aanmaken
      await saveProfile({ username, dz, api, lat, lon });
      $('#authMsg').textContent='Account aangemaakt. Check eventueel je e‑mail (confirm). Log nu in.';
    };

    $('#btnLogin').onclick = async ()=>{
      const email=$('#loginEmail').value.trim(); const pass=$('#loginPass').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if(error){ $('#authMsg').textContent = 'Login fout: '+error.message; return; }
      showApp(); refreshAll();
    };

    $('#btnLogout').onclick = async ()=>{ await supabase.auth.signOut(); showAuth(); };

    // Profile save
    $('#btnSaveProfile').onclick = async ()=>{
      const p={ username:$('#pUsername').value.trim(), dz:$('#pDZ').value.trim(), api:$('#pApi').value.trim(), lat:parseFloat($('#pLat').value), lon:parseFloat($('#pLon').value) };
      try{ await saveProfile(p); alert('Profiel opgeslagen'); refreshAll(); }catch(e){ alert('Opslaan mislukt: '+e.message); }
    };

    // Weather refresh
    let lastWeather=null;
    $('#btnRefreshWeather').onclick = async ()=>{
      const p={ lat:parseFloat($('#pLat').value), lon:parseFloat($('#pLon').value), api:$('#pApi').value.trim() };
      try{ const w=await fetchWeather(p.lat,p.lon,p.api); lastWeather=w; renderWeather(p,w);}catch(e){ alert('Weer ophalen mislukt'); }
    };

    // Jump form
    $('#btnFormWeather').onclick = async ()=>{
      const lat=parseFloat($('#jfLat').value), lon=parseFloat($('#jfLon').value); const api=$('#pApi').value.trim();
      try{ const w=await fetchWeather(lat,lon,api); lastWeather=w; $('#formWeatherSnapshot').textContent = `Weer: ${fmt(w.wind,0)} km/u, gust ${fmt(w.gust,0)}, ${fmt((w.vis||0)/1000,1)} km zicht, ${fmt(w.cloud,0)}% bewolking, ${fmt(w.precipProb||0,0)}%/${fmt(w.precip||0,1)} mm, ${wmoText(w.code)}`; }catch{ $('#formWeatherSnapshot').textContent='Weer mislukt'; }
    };

    $('#jumpForm').onsubmit = async (ev)=>{
      ev.preventDefault();
      const j={ date: new Date($('#jfDate').value).toISOString(), dz:$('#jfDZ').value.trim(), type:$('#jfType').value, exitAlt:parseInt($('#jfExit').value), openAlt:parseInt($('#jfOpen').value), ff:parseInt($('#jfFF').value), lat:parseFloat($('#jfLat').value), lon:parseFloat($('#jfLon').value), notes:$('#jfNotes').value.trim(), weather:lastWeather||null };
      try{ await saveJump(j); $('#jfFF').value=''; $('#jfNotes').value=''; await refreshAll(); }catch(e){ alert('Opslaan mislukt: '+e.message); }
    };

    // Initialize
    (async function init(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(user){ showApp(); refreshAll(); } else { showAuth(); }
      $('#jfDate').value = nowLocalDatetime();
    })();
  })();
  </script>
</body>
</html>
